#!/usr/bin/env bash

# subcheck user-mode service wrapper (no systemd)
# Manages start/stop/status/logs using nohup and a PID file under XDG_STATE_HOME

set -euo pipefail

BLUE="\033[1;34m"
GREEN="\033[1;32m"
RED="\033[1;31m"
YELLOW="\033[1;33m"
NC="\033[0m"

XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
XDG_STATE_HOME="${XDG_STATE_HOME:-$HOME/.local/state}"

PREFIX_DIR="${SUBCHECK_PREFIX:-$XDG_DATA_HOME/subcheck}"
CONFIG_FILE="${SUBCHECK_CONFIG:-$XDG_CONFIG_HOME/subcheck/config.yaml}"
STATE_DIR="$XDG_STATE_HOME/subcheck"
LOG_DIR="$STATE_DIR/logs"
PID_FILE="$STATE_DIR/subcheck.pid"
BIN="$PREFIX_DIR/subcheck"
LOG_FILE="$LOG_DIR/subcheck.log"

ensure_dirs() {
  mkdir -p "$PREFIX_DIR" "$LOG_DIR"
}

# Try to resolve legacy install paths when XDG paths are missing
resolve_paths() {
  local changed=0
  if [[ ! -x "$BIN" ]]; then
    if [[ -x "/opt/subcheck/subcheck" ]]; then
      BIN="/opt/subcheck/subcheck"
      changed=1
      echo -e "${YELLOW}Using legacy binary path: ${BIN}${NC}"
    fi
  fi
  if [[ ! -f "$CONFIG_FILE" ]]; then
    if [[ -f "/etc/subcheck/config.yaml" ]]; then
      CONFIG_FILE="/etc/subcheck/config.yaml"
      changed=1
      echo -e "${YELLOW}Using legacy config path: ${CONFIG_FILE}${NC}"
    else
      local bindir
      bindir="$(dirname "$BIN" 2>/dev/null || true)"
      if [[ -n "$bindir" && -f "$bindir/config/config.yaml" ]]; then
        CONFIG_FILE="$bindir/config/config.yaml"
        changed=1
        echo -e "${YELLOW}Using binary-local config path: ${CONFIG_FILE}${NC}"
      fi
    fi
  fi
  return 0
}

is_running() {
  # returns 0 if running, 1 otherwise
  if [[ -f "$PID_FILE" ]]; then
    local pid
    pid=$(cat "$PID_FILE" 2>/dev/null || true)
    if [[ -n "${pid}" ]] && kill -0 "$pid" 2>/dev/null; then
      return 0
    fi
  fi
  return 1
}

start_service() {
  ensure_dirs
  resolve_paths
  if [[ ! -x "$BIN" ]]; then
    echo -e "${RED}Binary not found or not executable: ${BIN}${NC}"
    echo -e "${YELLOW}Please run the installer first or check your installation path.${NC}"
    exit 1
  fi
  if [[ ! -f "$CONFIG_FILE" ]]; then
    echo -e "${RED}Config not found: ${CONFIG_FILE}${NC}"
    exit 1
  fi
  if is_running; then
    echo -e "${YELLOW}subcheck is already running (pid $(cat "$PID_FILE"))${NC}"
    exit 0
  fi
  echo -e "${BLUE}Starting subcheck...${NC}"
  # Use nohup to detach and write logs to LOG_FILE
  nohup "$BIN" -f "$CONFIG_FILE" >>"$LOG_FILE" 2>&1 &
  echo -n $! >"$PID_FILE"
  sleep 0.5
  if is_running; then
    echo -e "${GREEN}subcheck started (pid $(cat "$PID_FILE"))${NC}"
  else
    echo -e "${RED}Failed to start subcheck. See logs: ${LOG_FILE}${NC}"
    exit 1
  fi
}

stop_service() {
  if ! is_running; then
    echo -e "${YELLOW}subcheck is not running${NC}"
    rm -f "$PID_FILE" 2>/dev/null || true
    exit 0
  fi
  local pid
  pid=$(cat "$PID_FILE")
  echo -e "${BLUE}Stopping subcheck (pid ${pid})...${NC}"
  kill "$pid" 2>/dev/null || true
  for _ in {1..20}; do
    if ! kill -0 "$pid" 2>/dev/null; then
      break
    fi
    sleep 0.2
  done
  if kill -0 "$pid" 2>/dev/null; then
    echo -e "${YELLOW}Force killing subcheck (pid ${pid})...${NC}"
    kill -9 "$pid" 2>/dev/null || true
  fi
  rm -f "$PID_FILE" 2>/dev/null || true
  echo -e "${GREEN}subcheck stopped${NC}"
}

status_service() {
  if is_running; then
    echo -e "${GREEN}subcheck is running (pid $(cat "$PID_FILE"))${NC}"
    exit 0
  else
    echo -e "${YELLOW}subcheck is not running${NC}"
    exit 1
  fi
}

logs_service() {
  ensure_dirs
  echo -e "${BLUE}Tailing logs: ${LOG_FILE} (Ctrl+C to exit)${NC}"
  touch "$LOG_FILE"
  tail -f "$LOG_FILE"
}

restart_service() {
  stop_service || true
  start_service
}

usage() {
  cat <<EOF
Usage: subcheck-service <command>

Commands:
  start     Start subcheck in background (nohup)
  stop      Stop subcheck by PID file
  status    Show running status
  restart   Restart the service
  logs      Tail logs
EOF
}

cmd="${1:-}" || true
case "$cmd" in
  start) start_service ;;
  stop) stop_service ;;
  status) status_service ;;
  restart) restart_service ;;
  logs) logs_service ;;
  *) usage; exit 1 ;;
 esac
